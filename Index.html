<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Puppeteer v7.2</title>

    <meta name="theme-color" content="#0b1020">
    <link rel="manifest" href="./manifest.webmanifest">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="./icon-512.png">

    <style>
        :root {
            --bg: #0b1020; --panel: #151a2a; --input: #202636;
            --accent: #5c9ce6; --text: #e0e0e0; --sub: #8899a6;
            --border: #2a3545; --danger: #e57373; --success: #4caf50;
            --safe-area-top: env(safe-area-inset-top);
            --safe-area-bottom: env(safe-area-inset-bottom);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; font-family: -apple-system, sans-serif;
            background: var(--bg); color: var(--text);
            display: flex; flex-direction: column; height: 100vh; overflow: hidden;
            padding-top: var(--safe-area-top); padding-bottom: var(--safe-area-bottom);
        }

        /* Header */
        header {
            background: rgba(11, 16, 32, 0.95); padding: 0 15px; height: 50px;
            border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; z-index: 100;
        }
        .logo { font-weight:bold; color:var(--accent); letter-spacing: 1px; }
        .menu-trigger { font-size: 1.5rem; background: none; border: none; color: #fff; padding: 5px; cursor: pointer; }

        /* Tabs */
        .tabs { display: flex; background: var(--bg); border-bottom: 1px solid var(--border); flex-shrink: 0; }
        .tab {
            flex: 1; text-align: center; padding: 12px 0; font-size: 0.9rem; color: var(--sub);
            border-bottom: 3px solid transparent; cursor: pointer; transition: 0.2s;
        }
        .tab.active { color: var(--accent); border-bottom-color: var(--accent); font-weight: bold; background: var(--panel); }

        /* Container */
        #container { display: flex; flex: 1; overflow: hidden; position: relative; }
        
        /* Sidebar (Drawer) */
        #sidebar {
            width: 300px; background: var(--panel); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; z-index: 200;
            transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @media (max-width: 768px) {
            #sidebar { position: absolute; top: 0; left: 0; height: 100%; transform: translateX(-100%); box-shadow: 10px 0 30px rgba(0,0,0,0.7); }
            #sidebar.open { transform: translateX(0); }
        }
        #overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 150; display: none; backdrop-filter: blur(2px);
        }
        #overlay.open { display: block; }

        /* --- VISUAL LIST ITEMS --- */
        .char-item {
            padding: 12px 15px; border-bottom: 1px solid var(--border); 
            display: flex; align-items: center; justify-content: space-between;
            cursor: pointer; transition: background 0.2s;
            position: relative;
        }
        /* Default state (inactive) */
        .char-item { border-left: 4px solid transparent; opacity: 0.7; }
        
        /* Active (Included in Prompt) State */
        .char-item.is-active {
            background: rgba(92, 156, 230, 0.1);
            border-left-color: var(--accent);
            opacity: 1.0;
        }
        /* Selected (Editing) State */
        .char-item.is-editing {
            background: rgba(255, 255, 255, 0.05);
        }
        .char-item.is-active.is-editing {
            background: rgba(92, 156, 230, 0.15);
        }

        .char-info { flex: 1; margin-left: 10px; }
        .char-name { font-weight: bold; font-size: 0.95rem; display: block; }
        .char-status { font-size: 0.7rem; color: var(--sub); text-transform: uppercase; letter-spacing: 0.5px; }
        .is-active .char-status { color: var(--accent); font-weight: bold; text-shadow: 0 0 5px rgba(92, 156, 230, 0.5); }

        /* Toggle Switch */
        .toggle-switch {
            position: relative; width: 44px; height: 24px; flex-shrink: 0;
        }
        .toggle-input { opacity: 0; width: 0; height: 0; }
        .toggle-slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #333; transition: .3s; border-radius: 24px;
        }
        .toggle-slider:before {
            position: absolute; content: ""; height: 18px; width: 18px;
            left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%;
        }
        .toggle-input:checked + .toggle-slider { background-color: var(--accent); }
        .toggle-input:checked + .toggle-slider:before { transform: translateX(20px); }

        /* Main Panel */
        #main-panel { flex: 1; display: flex; flex-direction: column; background: var(--bg); overflow: hidden; }
        .content-view { flex: 1; overflow-y: auto; padding: 15px; display: none; }
        .content-view.active { display: block; }

        /* Inputs */
        h3 { 
            border-left: 4px solid var(--accent); padding-left: 10px; margin: 25px 0 15px; color: #fff;
            background: linear-gradient(90deg, rgba(92,156,230,0.1), transparent); padding-top:5px; padding-bottom:5px;
        }
        .row { display: flex; gap: 10px; margin-bottom: 8px; } .col { flex: 1; }
        input, textarea, select {
            width: 100%; background: var(--input); border: 1px solid var(--border);
            color: #fff; padding: 12px; border-radius: 8px; font-size: 16px; margin-bottom: 10px; appearance: none;
        }
        input:focus, textarea:focus { border-color: var(--accent); outline: none; box-shadow: 0 0 0 2px rgba(92,156,230,0.2); }
        label { display: block; color: var(--sub); font-size: 0.8rem; margin-bottom: 4px; }
        
        .btn { background: var(--input); color: #fff; border: 1px solid var(--border); padding: 12px; border-radius: 8px; font-size: 0.9rem; cursor: pointer; text-align: center;}
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--accent); border: none; font-weight: bold; }
        .btn-danger { background: rgba(229, 115, 115, 0.2); border: 1px solid var(--danger); color: var(--danger); }

        /* Prompt Area */
        #prompt-container {
            border-top: 1px solid var(--border); background: var(--panel); padding: 15px;
            display: flex; flex-direction: column; flex-shrink: 0; padding-bottom: calc(15px + var(--safe-area-bottom));
        }
        #generated-prompt {
            height: 100px; background: #080a10; color: #81c784; font-family: 'Menlo', 'Consolas', monospace; 
            border: 1px solid var(--border); padding: 10px; border-radius: 8px; font-size: 0.8rem; resize: none;
        }
    </style>
</head>
<body>

<div id="overlay" onclick="toggleSidebar()"></div>

<header>
    <button class="menu-trigger" onclick="toggleSidebar()">☰</button>
    <div class="logo">Puppeteer v7.2</div>
    <button class="btn btn-primary" style="padding: 6px 16px; font-size:0.85rem;" onclick="copyPrompt()">Copy</button>
</header>

<div class="tabs">
    <div class="tab active" onclick="setTab('char')">キャラ設定</div>
    <div class="tab" onclick="setTab('world')">世界観</div>
    <div class="tab" onclick="setTab('save')">保存/読込</div>
</div>

<div id="container">
    <div id="sidebar">
        <div style="padding:15px; font-size:0.8rem; color:var(--sub); border-bottom:1px solid var(--border); background:rgba(0,0,0,0.2);">
            スイッチONでプロンプトに追加
        </div>
        <div id="char-list" style="flex:1; overflow-y:auto;"></div>
        <div style="padding:15px;">
            <button class="btn" style="width:100%" onclick="addNewChar()">+ 新規キャラ作成</button>
        </div>
    </div>

    <div id="main-panel">
        <div id="view-char" class="content-view active">
            <div id="char-editor">
                <h3>Identity</h3>
                <div class="row">
                    <div class="col"><label>名前</label><input type="text" data-key="name" oninput="updateChar()"></div>
                </div>
                <div class="row">
                    <div class="col"><label>呼称(対ユーザー)</label><input type="text" data-key="userCall" oninput="updateChar()"></div>
                    <div class="col"><label>関係性</label><input type="text" data-key="relation" oninput="updateChar()"></div>
                </div>

                <h3>Profile</h3>
                <label>外見・服装</label><textarea data-key="appearance" rows="2" oninput="updateChar()"></textarea>
                <label>性格・役割</label><textarea data-key="personality" rows="2" oninput="updateChar()"></textarea>
                <div class="row">
                    <div class="col"><label>身体/年齢</label><input type="text" data-key="stats" oninput="updateChar()"></div>
                    <div class="col"><label>場所</label><input type="text" data-key="location" oninput="updateChar()"></div>
                </div>

                <h3>Voice & Tone</h3>
                <div class="row">
                    <div class="col"><label>一人称</label><input type="text" data-key="p1" oninput="updateChar()"></div>
                    <div class="col"><label>二人称</label><input type="text" data-key="p2" oninput="updateChar()"></div>
                </div>
                <label>語尾・口調</label><input type="text" data-key="tone" oninput="updateChar()">
                <label style="color:var(--accent); font-weight:bold;">★セリフサンプル</label>
                <textarea data-key="samples" rows="4" placeholder="口調の例..." oninput="updateChar()"></textarea>

                <h3>Custom Fields</h3>
                <div id="custom-fields"></div>
                <button class="btn" style="width:100%; border-style:dashed; margin-top:10px; background:transparent;" onclick="addCustomField()">+ 自由項目追加</button>

                <div style="margin-top:50px; text-align:center;">
                    <button class="btn btn-danger" style="width:100%;" onclick="deleteChar()">このキャラを削除</button>
                </div>
                <div style="height:50px;"></div>
            </div>
        </div>

        <div id="view-world" class="content-view">
            <h3>World Context</h3>
            <label>世界名</label><input id="world-name" oninput="updateWorld()">
            <label>舞台設定</label><textarea id="world-setting" rows="4" oninput="updateWorld()"></textarea>
            <label>ルール</label><textarea id="world-rules" rows="4" oninput="updateWorld()"></textarea>
            <label>現在状況</label><textarea id="world-situation" rows="3" oninput="updateWorld()"></textarea>
        </div>

        <div id="view-save" class="content-view">
            <h3>Save Points</h3>
            <div style="background:var(--panel); padding:15px; border-radius:8px; margin-bottom:20px; border:1px solid var(--border);">
                <label>現在の状態を保存</label>
                <div style="display:flex; gap:10px;">
                    <input id="save-name" placeholder="名前を付ける" style="margin:0;">
                    <button class="btn btn-primary" onclick="createSavePoint()">保存</button>
                </div>
            </div>
            <div id="save-list"></div>
        </div>
    </div>

    <div id="prompt-container">
        <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
            <span style="font-size:0.75rem; color:var(--sub); font-weight:bold;">GENERATED PROMPT</span>
            <span id="char-count" style="font-size:0.75rem; color:var(--accent); font-weight:bold;">0 Active</span>
        </div>
        <textarea id="generated-prompt" readonly onclick="this.select()"></textarea>
    </div>
</div>

<script>
    const DB_KEY = 'puppeteer_v7_highvis';
    
    // Default Data
    const initialMobs = [
        { id: 1, active: true, name: "モブ男", userCall: "君", relation: "友人", appearance: "Tシャツ", personality: "平凡", stats: "170cm", location: "街", p1: "俺", p2: "君", tone: "普通", samples: "「マジかよ」", custom: [] },
        { id: 2, active: false, name: "モブ女", userCall: "先輩", relation: "後輩", appearance: "制服", personality: "元気", stats: "158cm", location: "学校", p1: "私", p2: "先輩", tone: "JK", samples: "「先輩ちーっす！」", custom: [] },
        { id: 3, active: false, name: "モブ猫", userCall: "人間", relation: "下僕", appearance: "三毛", personality: "尊大", stats: "30cm", location: "路地", p1: "吾輩", p2: "お前", tone: "猫語", samples: "「にゃあ（餌をよこせ）」", custom: [] }
    ];

    let appData = {
        world: { name: "", setting: "", rules: "", situation: "" },
        chars: JSON.parse(JSON.stringify(initialMobs)),
        saves: []
    };
    let editingCharId = null;

    // --- Init ---
    function init() {
        const loaded = localStorage.getItem(DB_KEY);
        if(loaded) {
            try { appData = {...appData, ...JSON.parse(loaded)}; } catch(e){}
        }
        if(appData.chars.length === 0) appData.chars = JSON.parse(JSON.stringify(initialMobs));
        
        // Ensure active defaults if missing
        appData.chars.forEach(c => { if(typeof c.active === 'undefined') c.active = false; });

        editingCharId = appData.chars[0].id;
        renderAll();
    }

    function saveDB() { localStorage.setItem(DB_KEY, JSON.stringify(appData)); generatePrompt(); }

    // --- UI Logic ---
    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('open');
        document.getElementById('overlay').classList.toggle('open');
    }

    function setTab(t) {
        document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.content-view').forEach(e => e.classList.remove('active'));
        if(t==='char') { document.querySelectorAll('.tab')[0].classList.add('active'); document.getElementById('view-char').classList.add('active'); }
        if(t==='world') { document.querySelectorAll('.tab')[1].classList.add('active'); document.getElementById('view-world').classList.add('active'); }
        if(t==='save') { document.querySelectorAll('.tab')[2].classList.add('active'); document.getElementById('view-save').classList.add('active'); }
    }

    // --- Renderers ---
    function renderAll() {
        renderCharList(); loadCharForm(); loadWorldForm(); renderSaveList(); generatePrompt();
    }

    // ★ HIGH VISIBILITY LIST RENDERING
    function renderCharList() {
        const list = document.getElementById('char-list');
        list.innerHTML = '';
        
        appData.chars.forEach(c => {
            const isActive = c.active;
            const isEditing = c.id === editingCharId;
            
            const div = document.createElement('div');
            // Add classes for styling
            div.className = `char-item ${isActive ? 'is-active' : ''} ${isEditing ? 'is-editing' : ''}`;
            
            // 1. Toggle Switch
            const label = document.createElement('label');
            label.className = 'toggle-switch';
            
            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'toggle-input';
            checkbox.checked = isActive;
            
            const slider = document.createElement('span');
            slider.className = 'toggle-slider';

            label.appendChild(checkbox);
            label.appendChild(slider);

            // Toggle Event
            checkbox.addEventListener('change', (e) => {
                c.active = checkbox.checked;
                saveDB();
                renderCharList(); // Re-render for visual update
            });
            // Stop propagation so clicking toggle doesn't select for edit
            label.addEventListener('click', (e) => e.stopPropagation());

            // 2. Info Area
            const info = document.createElement('div');
            info.className = 'char-info';
            info.innerHTML = `
                <span class="char-name">${c.name}</span>
                <span class="char-status">${isActive ? '● ACTIVE' : '○ OFF'}</span>
            `;

            // Row Click Event (Edit Selection)
            div.addEventListener('click', () => {
                editingCharId = c.id;
                renderAll();
                if(window.innerWidth <= 768) toggleSidebar(); 
            });

            div.appendChild(label);
            div.appendChild(info);
            list.appendChild(div);
        });
        updateCharCount();
    }

    function updateCharCount() {
        const count = appData.chars.filter(c => c.active).length;
        document.getElementById('char-count').innerText = `${count} Active`;
    }

    // --- Form Logic ---
    function loadCharForm() {
        const c = appData.chars.find(x => x.id === editingCharId);
        if(!c) return;
        document.querySelectorAll('#char-editor [data-key]').forEach(el => el.value = c[el.getAttribute('data-key')] || "");
        
        const cf = document.getElementById('custom-fields'); cf.innerHTML = '';
        if(c.custom) c.custom.forEach((f,i) => {
            const row = document.createElement('div'); row.className = 'row';
            row.innerHTML = `<input value="${f.label}" oninput="updCust(${i},'label',this.value)" placeholder="項目" style="width:40%"><input value="${f.value}" oninput="updCust(${i},'value',this.value)" placeholder="値"><button class="btn" style="padding:0 15px;" onclick="delCust(${i})">×</button>`;
            cf.appendChild(row);
        });
    }

    window.updateChar = () => {
        const c = appData.chars.find(x => x.id === editingCharId);
        document.querySelectorAll('#char-editor [data-key]').forEach(el => c[el.getAttribute('data-key')] = el.value);
        saveDB(); 
        // Update list name only, avoid full re-render while typing
        const activeItem = document.querySelector('.char-item.is-editing .char-name');
        if(activeItem) activeItem.innerText = c.name;
    }
    
    window.addCustomField = () => { appData.chars.find(x=>x.id===editingCharId).custom.push({label:"",value:""}); saveDB(); loadCharForm(); }
    window.updCust = (i,k,v) => { appData.chars.find(x=>x.id===editingCharId).custom[i][k] = v; saveDB(); }
    window.delCust = (i) => { appData.chars.find(x=>x.id===editingCharId).custom.splice(i,1); saveDB(); loadCharForm(); }

    window.addNewChar = () => { 
        const n = JSON.parse(JSON.stringify(initialMobs[0])); 
        n.id=Date.now(); n.name="新規キャラ"; n.active=false; 
        appData.chars.push(n); editingCharId=n.id; 
        saveDB(); renderAll(); 
    }
    window.deleteChar = () => {
        if(appData.chars.length <= 1 || !confirm("削除しますか？")) return;
        appData.chars = appData.chars.filter(c => c.id !== editingCharId);
        editingCharId = appData.chars[0].id; saveDB(); renderAll();
    }

    // --- World & Save ---
    function loadWorldForm() {
        document.getElementById('world-name').value = appData.world.name;
        document.getElementById('world-setting').value = appData.world.setting;
        document.getElementById('world-rules').value = appData.world.rules;
        document.getElementById('world-situation').value = appData.world.situation;
    }
    window.updateWorld = () => {
        appData.world = {
            name: document.getElementById('world-name').value,
            setting: document.getElementById('world-setting').value,
            rules: document.getElementById('world-rules').value,
            situation: document.getElementById('world-situation').value
        }; saveDB();
    }
    window.createSavePoint = () => {
        const n = document.getElementById('save-name').value; if(!n) return;
        appData.saves.unshift({name:n, time:new Date().toLocaleString(), data:JSON.parse(JSON.stringify({w:appData.world, c:appData.chars}))});
        document.getElementById('save-name').value=''; saveDB(); renderSaveList();
    }
    function renderSaveList() {
        const l = document.getElementById('save-list'); l.innerHTML='';
        appData.saves.forEach((s,i) => {
            const d = document.createElement('div'); 
            d.style.cssText = 'padding:15px; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center;';
            d.innerHTML = `<div><div style="font-weight:bold">${s.name}</div><div style="font-size:0.75rem; color:#888">${s.time}</div></div><div style="display:flex; gap:10px;"><button class="btn btn-primary" onclick="loadSave(${i})">Load</button> <button class="btn btn-danger" onclick="delSave(${i})">Del</button></div>`;
            l.appendChild(d);
        });
    }
    window.loadSave = (i) => { if(confirm("ロードしますか？")) { const s=appData.saves[i]; appData.world=s.data.w; appData.chars=s.data.c; editingCharId=appData.chars[0].id; saveDB(); renderAll(); } }
    window.delSave = (i) => { appData.saves.splice(i,1); saveDB(); renderSaveList(); }

    // --- Prompt ---
    function generatePrompt() {
        const ac = appData.chars.filter(c => c.active); const w = appData.world;
        let p = `# System: Multi-Roleplay\n\n## 1. World Context\n- Name: ${w.name}\n- Setting: ${w.setting.replace(/\n/g,' ')}\n- Rules: ${w.rules.replace(/\n/g,' ')}\n- Situation: ${w.situation}\n\n## 2. Characters\n`;
        ac.forEach(c => {
            p += `\n### ■ ${c.name}\n- Role: ${c.role}\n- UserCall: ${c.userCall} (${c.relation})\n- Appearance: ${c.appearance}\n- Personality: ${c.personality}\n- Stats: ${c.stats} / ${c.location}\n- Speech: P1=${c.p1}, P2=${c.p2}, Tone=${c.tone}\n- Samples:\n${(c.samples||"").replace(/^/gm,'  > ')}\n`;
            if(c.custom && c.custom.length) p += `- Extra: ${c.custom.map(f=>`${f.label}:${f.value}`).join(', ')}\n`;
        });
        p += `\n## 3. Instructions\n- Strictly follow the personas and speech samples.\n- Identify speaker with [Name] at start.`;
        document.getElementById('generated-prompt').value = p;
    }
    window.copyPrompt = () => { document.getElementById('generated-prompt').select(); document.execCommand('copy'); alert("プロンプトをコピーしました"); }

    init();
</script>
</body>
</html>
