<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Puppeteer v8</title>

    <meta name="theme-color" content="#0b1020">
    <link rel="manifest" href="./manifest.webmanifest">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="apple-touch-icon" href="./icon-512.png">

    <style>
        :root {
            --bg: #0b1020; --panel: #151a2a; --input: #202636;
            --accent: #5c9ce6; --text: #e0e0e0; --sub: #8899a6;
            --border: #2a3545; --danger: #e57373; --success: #4caf50;
            --warning: #ffa726;
            --safe-area-top: env(safe-area-inset-top);
            --safe-area-bottom: env(safe-area-inset-bottom);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

        body {
            margin: 0; font-family: -apple-system, sans-serif;
            background: var(--bg); color: var(--text);
            display: flex; flex-direction: column; height: 100vh; overflow: hidden;
            padding-top: var(--safe-area-top); padding-bottom: var(--safe-area-bottom);
        }

        /* Header */
        header {
            background: rgba(11, 16, 32, 0.95); padding: 0 15px; height: 50px;
            border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; z-index: 100;
        }
        .logo { font-weight:bold; color:var(--accent); letter-spacing: 1px; }
        .menu-trigger { font-size: 1.5rem; background: none; border: none; color: #fff; padding: 5px; cursor: pointer; }
        .header-actions { display: flex; gap: 8px; align-items: center; }

        /* Menu Panel */
        #menu-panel {
            position: fixed; top: 50px; left: 0; width: 280px; height: calc(100vh - 50px);
            background: var(--panel); border-right: 1px solid var(--border);
            transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 250; display: flex; flex-direction: column;
        }
        #menu-panel.open { transform: translateX(0); }
        .menu-item {
            padding: 16px 20px; border-bottom: 1px solid var(--border);
            cursor: pointer; transition: background 0.2s; font-size: 0.95rem;
        }
        .menu-item:hover { background: rgba(92, 156, 230, 0.1); }
        .menu-item.active {
            background: rgba(92, 156, 230, 0.15); color: var(--accent);
            border-left: 4px solid var(--accent); font-weight: bold;
        }
        .menu-section-title {
            padding: 12px 20px; font-size: 0.7rem; color: var(--sub);
            text-transform: uppercase; letter-spacing: 1px; font-weight: bold;
            background: rgba(0, 0, 0, 0.3);
        }

        /* Container */
        #container { display: flex; flex: 1; overflow: hidden; position: relative; }

        /* Sidebar (Drawer) */
        #sidebar {
            position: fixed; top: 50px; left: 0; width: 300px; height: calc(100vh - 50px);
            background: var(--panel); border-right: 1px solid var(--border);
            display: flex; flex-direction: column; z-index: 200;
            transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            box-shadow: 10px 0 30px rgba(0,0,0,0.7);
        }
        #sidebar.open { transform: translateX(0); }
        #overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.6); z-index: 190; display: none; backdrop-filter: blur(2px);
        }
        #overlay.open { display: block; }

        /* Character List Items */
        .char-item {
            padding: 12px 15px; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            cursor: pointer; transition: background 0.2s;
            position: relative;
        }
        .char-item { border-left: 4px solid transparent; opacity: 0.7; }
        .char-item.is-active {
            background: rgba(92, 156, 230, 0.1);
            border-left-color: var(--accent);
            opacity: 1.0;
        }
        .char-item.is-editing {
            background: rgba(255, 255, 255, 0.05);
        }
        .char-item.is-active.is-editing {
            background: rgba(92, 156, 230, 0.15);
        }

        .char-info { flex: 1; margin-left: 10px; }
        .char-name { font-weight: bold; font-size: 0.95rem; display: block; }
        .char-status { font-size: 0.7rem; color: var(--sub); text-transform: uppercase; letter-spacing: 0.5px; }
        .is-active .char-status { color: var(--accent); font-weight: bold; text-shadow: 0 0 5px rgba(92, 156, 230, 0.5); }

        /* Toggle Switch */
        .toggle-switch {
            position: relative; width: 44px; height: 24px; flex-shrink: 0;
        }
        .toggle-input { opacity: 0; width: 0; height: 0; }
        .toggle-slider {
            position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
            background-color: #333; transition: .3s; border-radius: 24px;
        }
        .toggle-slider:before {
            position: absolute; content: ""; height: 18px; width: 18px;
            left: 3px; bottom: 3px; background-color: white; transition: .3s; border-radius: 50%;
        }
        .toggle-input:checked + .toggle-slider { background-color: var(--accent); }
        .toggle-input:checked + .toggle-slider:before { transform: translateX(20px); }

        /* Main Panel */
        #main-panel { flex: 1; display: flex; flex-direction: column; background: var(--bg); overflow: hidden; }
        .content-view { flex: 1; overflow-y: auto; padding: 15px; display: none; }
        .content-view.active { display: block; }

        /* Section Card Layout */
        .section-card {
            background: var(--panel); border: 1px solid var(--border); border-radius: 12px;
            padding: 20px; margin-bottom: 20px; position: relative;
        }
        .section-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;
        }
        .section-title {
            font-size: 1.1rem; font-weight: bold; color: var(--accent);
            border-left: 4px solid var(--accent); padding-left: 12px;
        }
        .section-actions {
            display: flex; gap: 8px;
        }
        .section-actions button {
            padding: 6px 12px; font-size: 0.75rem; border-radius: 6px;
        }

        /* Field Grid */
        .fields-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px; margin-bottom: 15px;
        }
        .field-item {
            display: flex; flex-direction: column;
        }
        .field-item-inline {
            display: flex; gap: 8px; align-items: flex-end;
        }
        .field-item-inline .field-item { flex: 1; margin-bottom: 0; }
        .field-item-inline button { flex-shrink: 0; height: 46px; padding: 0 12px; }

        /* Inputs */
        h3 {
            border-left: 4px solid var(--accent); padding-left: 10px; margin: 25px 0 15px; color: #fff;
            background: linear-gradient(90deg, rgba(92,156,230,0.1), transparent); padding-top:5px; padding-bottom:5px;
        }
        .row { display: flex; gap: 10px; margin-bottom: 8px; } .col { flex: 1; }
        input, textarea, select {
            width: 100%; background: var(--input); border: 1px solid var(--border);
            color: #fff; padding: 12px; border-radius: 8px; font-size: 16px; margin-bottom: 10px; appearance: none;
        }
        input:focus, textarea:focus { border-color: var(--accent); outline: none; box-shadow: 0 0 0 2px rgba(92,156,230,0.2); }
        label { display: block; color: var(--sub); font-size: 0.8rem; margin-bottom: 4px; }

        .btn {
            background: var(--input); color: #fff; border: 1px solid var(--border);
            padding: 12px; border-radius: 8px; font-size: 0.9rem; cursor: pointer; text-align: center;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--accent); border: none; font-weight: bold; }
        .btn-danger { background: rgba(229, 115, 115, 0.2); border: 1px solid var(--danger); color: var(--danger); }
        .btn-success { background: rgba(76, 175, 80, 0.2); border: 1px solid var(--success); color: var(--success); }
        .btn-dashed { border-style: dashed; background: transparent; }

        /* Prompt Mode Selector */
        .mode-selector {
            display: flex; gap: 15px; padding: 15px; background: rgba(0,0,0,0.2);
            border-radius: 8px; margin-bottom: 15px; flex-wrap: wrap;
        }
        .mode-option {
            display: flex; align-items: center; gap: 6px; cursor: pointer;
        }
        .mode-option input[type="radio"] {
            width: auto; margin: 0; cursor: pointer;
        }
        .mode-option label {
            margin: 0; cursor: pointer; color: var(--text); font-size: 0.85rem;
            white-space: nowrap;
        }
        @media (max-width: 500px) {
            .mode-option label { font-size: 0.75rem; }
            #editing-char-name { display: none; }
        }

        /* Relationship Matrix */
        #relationship-matrix {
            background: var(--panel); border: 1px solid var(--border);
            border-radius: 12px; padding: 20px; margin-bottom: 20px;
        }
        .relationship-pair {
            background: var(--input); padding: 15px; border-radius: 8px; margin-bottom: 12px;
        }
        .relationship-pair-header {
            font-size: 0.85rem; color: var(--accent); font-weight: bold; margin-bottom: 10px;
        }

        /* Prompt Panel */
        #prompt-panel {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: var(--panel); border-top: 2px solid var(--border);
            transform: translateY(100%); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1);
            z-index: 150; max-height: 70vh; display: flex; flex-direction: column;
            padding-bottom: var(--safe-area-bottom);
        }
        #prompt-panel.open { transform: translateY(0); }
        #prompt-panel-header {
            padding: 12px 15px; border-bottom: 1px solid var(--border);
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(0, 0, 0, 0.3);
        }
        #prompt-panel-title { font-weight: bold; color: var(--accent); font-size: 0.9rem; }
        #prompt-panel-content {
            padding: 15px; overflow-y: auto; flex: 1;
        }
        #generated-prompt {
            min-height: 150px; background: #080a10; color: #81c784; font-family: 'Menlo', 'Consolas', monospace;
            border: 1px solid var(--border); padding: 10px; border-radius: 8px; font-size: 0.8rem; resize: vertical;
        }
        .prompt-export-options {
            display: flex; gap: 10px; margin-top: 12px; flex-wrap: wrap; align-items: center;
        }
        .format-selector {
            display: flex; gap: 8px; align-items: center; padding: 8px 12px;
            background: rgba(0, 0, 0, 0.3); border-radius: 6px;
        }
        .format-selector label {
            margin: 0; font-size: 0.85rem; color: var(--text); cursor: pointer;
            display: flex; align-items: center; gap: 4px;
        }
        .format-selector input[type="radio"] { margin: 0; cursor: pointer; }

        /* Utility */
        .text-center { text-align: center; }
        .mb-10 { margin-bottom: 10px; }
        .mb-20 { margin-bottom: 20px; }
        .mt-20 { margin-top: 20px; }
    </style>
</head>
<body>

<div id="overlay" onclick="closeAllPanels()"></div>

<header>
    <button class="menu-trigger" onclick="toggleMenu()">â˜°</button>
    <div class="logo">Puppeteer v8</div>
    <div class="header-actions">
        <button class="menu-trigger" onclick="toggleSidebar()">ğŸ‘¥</button>
        <button class="menu-trigger" onclick="togglePromptPanel()">ğŸ“Š</button>
    </div>
</header>

<div id="menu-panel">
    <div class="menu-section-title">ã‚»ã‚¯ã‚·ãƒ§ãƒ³</div>
    <div class="menu-item active" onclick="setTabFromMenu('char')">
        <div>ğŸ“ ã‚­ãƒ£ãƒ©è¨­å®š</div>
    </div>
    <div class="menu-item" onclick="setTabFromMenu('world')">
        <div>ğŸŒ ä¸–ç•Œè¦³</div>
    </div>
    <div class="menu-item" onclick="setTabFromMenu('save')">
        <div>ğŸ’¾ ä¿å­˜/èª­è¾¼</div>
    </div>
    <div style="flex: 1;"></div>
    <div class="menu-section-title">ãƒ‘ãƒãƒ«</div>
    <div class="menu-item" onclick="toggleSidebar(); toggleMenu();">
        <div>ğŸ‘¥ ã‚­ãƒ£ãƒ©é¸æŠ</div>
    </div>
    <div class="menu-item" onclick="togglePromptPanel(); toggleMenu();">
        <div>ğŸ“Š ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ</div>
    </div>
</div>

<div id="container">
    <div id="sidebar">
        <div style="padding:15px; font-size:0.75rem; color:var(--sub); border-bottom:1px solid var(--border); background:rgba(0,0,0,0.2); line-height:1.5;">
            <div style="margin-bottom:5px;">ğŸ“ <strong>ã‚¯ãƒªãƒƒã‚¯</strong>: ç·¨é›†å¯¾è±¡ã«åˆ‡æ›¿</div>
            <div>ğŸ”˜ <strong>ã‚¹ã‚¤ãƒƒãƒON</strong>: ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«è¿½åŠ </div>
        </div>
        <div id="char-list" style="flex:1; overflow-y:auto;"></div>
        <div style="padding:15px;">
            <button class="btn" style="width:100%" onclick="addNewChar()">+ æ–°è¦ã‚­ãƒ£ãƒ©ä½œæˆ</button>
        </div>
    </div>

    <div id="main-panel">
        <div id="view-char" class="content-view active">
            <div id="char-editor"></div>
        </div>

        <div id="view-world" class="content-view">
            <h3>World Context</h3>
            <label>ä¸–ç•Œå</label><input id="world-name" oninput="updateWorld()">
            <label>èˆå°è¨­å®š</label><textarea id="world-setting" rows="4" oninput="updateWorld()"></textarea>
            <label>ãƒ«ãƒ¼ãƒ«</label><textarea id="world-rules" rows="4" oninput="updateWorld()"></textarea>
            <label>ç¾åœ¨çŠ¶æ³</label><textarea id="world-situation" rows="3" oninput="updateWorld()"></textarea>
        </div>

        <div id="view-save" class="content-view">
            <h3>Save Points</h3>
            <div style="background:var(--panel); padding:15px; border-radius:8px; margin-bottom:20px; border:1px solid var(--border);">
                <label>ç¾åœ¨ã®çŠ¶æ…‹ã‚’ä¿å­˜</label>
                <div style="display:flex; gap:10px;">
                    <input id="save-name" placeholder="åå‰ã‚’ä»˜ã‘ã‚‹" style="margin:0;">
                    <button class="btn btn-primary" onclick="createSavePoint()">ä¿å­˜</button>
                </div>
            </div>
            <div id="save-list"></div>
        </div>
    </div>

    </div>
</div>

<div id="prompt-panel">
    <div id="prompt-panel-header">
        <div id="prompt-panel-title">ğŸ“Š ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ</div>
        <button class="menu-trigger" onclick="togglePromptPanel()">âœ•</button>
    </div>
    <div id="prompt-panel-content">
        <div style="display:flex; justify-content:space-between; margin-bottom:12px; flex-wrap: wrap; gap: 8px;">
            <span style="font-size:0.75rem; color:var(--sub); font-weight:bold;">GENERATION MODE</span>
            <div style="display:flex; gap:15px; align-items:center; flex-wrap: wrap;">
                <span id="editing-char-name" style="font-size:0.75rem; color:var(--warning); font-weight:bold;">ç·¨é›†ä¸­: -</span>
                <span id="char-count" style="font-size:0.75rem; color:var(--accent); font-weight:bold;">0 Active</span>
            </div>
        </div>

        <div class="mode-selector">
            <div class="mode-option">
                <input type="radio" id="mode-single" name="genMode" value="single" onchange="updateGenerationMode()">
                <label for="mode-single">å˜ä½“ã‚­ãƒ£ãƒ©ï¼ˆç·¨é›†ä¸­ã®ã¿ï¼‰</label>
            </div>
            <div class="mode-option">
                <input type="radio" id="mode-multi" name="genMode" value="multi" onchange="updateGenerationMode()">
                <label for="mode-multi">è¤‡æ•°ã‚­ãƒ£ãƒ©ï¼ˆActiveï¼‰</label>
            </div>
            <div class="mode-option">
                <input type="radio" id="mode-world" name="genMode" value="world" onchange="updateGenerationMode()">
                <label for="mode-world">ä¸–ç•Œè¦³ã®ã¿</label>
            </div>
            <div class="mode-option">
                <input type="radio" id="mode-all" name="genMode" value="all" checked onchange="updateGenerationMode()">
                <label for="mode-all">çµ±åˆï¼ˆAllï¼‰</label>
            </div>
        </div>

        <div id="relationship-matrix" style="display:none;"></div>

        <textarea id="generated-prompt" readonly onclick="this.select()"></textarea>

        <div class="prompt-export-options">
            <div class="format-selector">
                <label><input type="radio" name="exportFormat" value="md" checked> .md</label>
                <label><input type="radio" name="exportFormat" value="txt"> .txt</label>
            </div>
            <button class="btn btn-primary" onclick="copyPrompt()" style="padding: 8px 16px;">ğŸ“‹ ã‚³ãƒ”ãƒ¼</button>
            <button class="btn btn-success" onclick="downloadPrompt()" style="padding: 8px 16px;">ğŸ’¾ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
        </div>
    </div>
</div>

<script>
    const DB_KEY = 'puppeteer_v8_dynamic';
    const DB_KEY_OLD = 'puppeteer_v7_highvis';

    // Default Character Template with Dynamic Schema
    function createDefaultCharacter() {
        return {
            id: Date.now(),
            active: false,
            name: "æ–°è¦ã‚­ãƒ£ãƒ©",
            sections: [
                {
                    id: 'identity',
                    name: 'Identity',
                    fixed: true,
                    fields: [
                        { key: 'name', label: 'åå‰', value: '', type: 'text', fixed: true },
                        { key: 'userCall', label: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼å‘¼ç§°', value: '', type: 'text', fixed: true }
                    ]
                },
                {
                    id: 'profile',
                    name: 'Profile',
                    fixed: true,
                    fields: [
                        { key: 'species', label: 'ç¨®æ—', value: '', type: 'text', fixed: true },
                        { key: 'family', label: 'å®¶æ—æ§‹æˆ', value: '', type: 'text', fixed: true },
                        { key: 'appearance', label: 'å¤–è¦‹', value: '', type: 'textarea', fixed: true },
                        { key: 'personality', label: 'æ€§æ ¼', value: '', type: 'textarea', fixed: true }
                    ]
                },
                {
                    id: 'memory',
                    name: 'Memory',
                    fixed: true,
                    fields: [
                        { key: 'memory1', label: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã®æ€ã„å‡º1', value: '', type: 'textarea', fixed: true },
                        { key: 'memory2', label: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã®æ€ã„å‡º2', value: '', type: 'textarea', fixed: true },
                        { key: 'memory3', label: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã®æ€ã„å‡º3', value: '', type: 'textarea', fixed: true }
                    ]
                },
                {
                    id: 'voice',
                    name: 'Voice',
                    fixed: true,
                    fields: [
                        { key: 'p1', label: 'ä¸€äººç§°', value: '', type: 'text', fixed: true },
                        { key: 'p2', label: 'äºŒäººç§°', value: '', type: 'text', fixed: true },
                        { key: 'tone', label: 'èªå°¾', value: '', type: 'text', fixed: true },
                        { key: 'samples', label: 'ã‚µãƒ³ãƒ—ãƒ«', value: '', type: 'textarea', fixed: true }
                    ]
                }
            ]
        };
    }

    // Migrate v7 data to v8 format
    function migrateV7ToV8(oldChar) {
        const newChar = createDefaultCharacter();
        newChar.id = oldChar.id;
        newChar.active = oldChar.active || false;

        // Map old fields to new structure
        const fieldMapping = {
            name: ['identity', 'name'],
            userCall: ['identity', 'userCall'],
            species: ['profile', 'species'],
            family: ['profile', 'family'],
            appearance: ['profile', 'appearance'],
            personality: ['profile', 'personality'],
            p1: ['voice', 'p1'],
            p2: ['voice', 'p2'],
            tone: ['voice', 'tone'],
            samples: ['voice', 'samples']
        };

        for (const [oldKey, [sectionId, fieldKey]] of Object.entries(fieldMapping)) {
            if (oldChar[oldKey]) {
                const section = newChar.sections.find(s => s.id === sectionId);
                if (section) {
                    const field = section.fields.find(f => f.key === fieldKey);
                    if (field) {
                        field.value = oldChar[oldKey];
                    }
                }
            }
        }

        // Migrate custom fields to a new custom section
        if (oldChar.custom && oldChar.custom.length > 0) {
            const customSection = {
                id: 'custom_' + Date.now(),
                name: 'Custom (Migrated)',
                fixed: false,
                fields: oldChar.custom.map((c, i) => ({
                    key: 'custom_' + i,
                    label: c.label,
                    value: c.value,
                    type: 'text',
                    fixed: false
                }))
            };
            newChar.sections.push(customSection);
        }

        return newChar;
    }

    let appData = {
        version: 8,
        generationMode: 'all',
        world: { name: "", setting: "", rules: "", situation: "" },
        chars: [],
        relationships: {}, // Format: "charId1_charId2": { from1to2: "text", from2to1: "text" }
        saves: []
    };
    let editingCharId = null;

    // --- Init ---
    function init() {
        // Try loading v8 data
        const loaded = localStorage.getItem(DB_KEY);
        if (loaded) {
            try {
                appData = {...appData, ...JSON.parse(loaded)};
            } catch(e) {
                console.error('Failed to load v8 data:', e);
            }
        } else {
            // Try migrating from v7
            const oldData = localStorage.getItem(DB_KEY_OLD);
            if (oldData) {
                try {
                    const v7Data = JSON.parse(oldData);
                    if (v7Data.chars && v7Data.chars.length > 0) {
                        appData.chars = v7Data.chars.map(c => migrateV7ToV8(c));
                        appData.world = v7Data.world || appData.world;
                        saveDB();
                        alert('v7.2ã‹ã‚‰v8ã«ãƒ‡ãƒ¼ã‚¿ã‚’ç§»è¡Œã—ã¾ã—ãŸï¼');
                    }
                } catch(e) {
                    console.error('Failed to migrate v7 data:', e);
                }
            }
        }

        // Ensure at least one character exists
        if (appData.chars.length === 0) {
            const defaultChar = createDefaultCharacter();
            defaultChar.name = "ã‚µãƒ³ãƒ—ãƒ«ã‚­ãƒ£ãƒ©";
            defaultChar.active = true;
            // Set some default values
            const nameField = defaultChar.sections.find(s => s.id === 'identity').fields.find(f => f.key === 'name');
            nameField.value = "ã‚µãƒ³ãƒ—ãƒ«ã‚­ãƒ£ãƒ©";
            appData.chars.push(defaultChar);
        }

        editingCharId = appData.chars[0].id;

        // Set generation mode
        document.querySelector(`input[name="genMode"][value="${appData.generationMode}"]`).checked = true;

        renderAll();
    }

    function saveDB() {
        localStorage.setItem(DB_KEY, JSON.stringify(appData));
        generatePrompt();
    }

    // --- UI Logic ---
    function closeAllPanels() {
        document.getElementById('sidebar').classList.remove('open');
        document.getElementById('menu-panel').classList.remove('open');
        document.getElementById('overlay').classList.remove('open');
    }

    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const menu = document.getElementById('menu-panel');
        const overlay = document.getElementById('overlay');

        if (sidebar.classList.contains('open')) {
            sidebar.classList.remove('open');
            overlay.classList.remove('open');
        } else {
            menu.classList.remove('open');
            sidebar.classList.add('open');
            overlay.classList.add('open');
        }
    }

    function toggleMenu() {
        const sidebar = document.getElementById('sidebar');
        const menu = document.getElementById('menu-panel');
        const overlay = document.getElementById('overlay');

        if (menu.classList.contains('open')) {
            menu.classList.remove('open');
            overlay.classList.remove('open');
        } else {
            sidebar.classList.remove('open');
            menu.classList.add('open');
            overlay.classList.add('open');
        }
    }

    function togglePromptPanel() {
        document.getElementById('prompt-panel').classList.toggle('open');
    }

    function setTab(t) {
        document.querySelectorAll('.content-view').forEach(e => e.classList.remove('active'));
        if(t==='char') { document.getElementById('view-char').classList.add('active'); }
        if(t==='world') { document.getElementById('view-world').classList.add('active'); }
        if(t==='save') { document.getElementById('view-save').classList.add('active'); }
    }

    function setTabFromMenu(t) {
        // Update menu items
        document.querySelectorAll('#menu-panel .menu-item').forEach((item, idx) => {
            if (idx < 3) item.classList.remove('active');
        });
        const menuItems = document.querySelectorAll('#menu-panel .menu-item');
        if(t==='char') menuItems[0].classList.add('active');
        if(t==='world') menuItems[1].classList.add('active');
        if(t==='save') menuItems[2].classList.add('active');

        // Switch view
        setTab(t);

        // Close menu
        toggleMenu();
    }

    window.updateGenerationMode = () => {
        const mode = document.querySelector('input[name="genMode"]:checked').value;
        appData.generationMode = mode;
        saveDB();
        renderRelationshipMatrix();
    }

    // --- Renderers ---
    function renderAll() {
        renderCharList();
        renderCharEditor();
        loadWorldForm();
        renderSaveList();
        renderRelationshipMatrix();
        generatePrompt();
    }

    function renderCharList() {
        const list = document.getElementById('char-list');
        list.innerHTML = '';

        appData.chars.forEach(c => {
            const isActive = c.active;
            const isEditing = c.id === editingCharId;

            const div = document.createElement('div');
            div.className = `char-item ${isActive ? 'is-active' : ''} ${isEditing ? 'is-editing' : ''}`;

            const label = document.createElement('label');
            label.className = 'toggle-switch';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.className = 'toggle-input';
            checkbox.checked = isActive;

            const slider = document.createElement('span');
            slider.className = 'toggle-slider';

            label.appendChild(checkbox);
            label.appendChild(slider);

            checkbox.addEventListener('change', (e) => {
                c.active = checkbox.checked;
                saveDB();
                renderCharList();
                renderRelationshipMatrix();
            });
            label.addEventListener('click', (e) => e.stopPropagation());

            const info = document.createElement('div');
            info.className = 'char-info';

            // Get character name from sections
            const nameField = c.sections.find(s => s.id === 'identity')?.fields.find(f => f.key === 'name');
            const charName = nameField?.value || c.name || 'åç„¡ã—';

            info.innerHTML = `
                <span class="char-name">${charName}</span>
                <span class="char-status">${isActive ? 'â— ACTIVE' : 'â—‹ OFF'}</span>
            `;

            div.addEventListener('click', () => {
                editingCharId = c.id;
                renderAll();
                if(window.innerWidth <= 768) toggleSidebar();
            });

            div.appendChild(label);
            div.appendChild(info);
            list.appendChild(div);
        });
        updateCharCount();
    }

    function updateCharCount() {
        const count = appData.chars.filter(c => c.active).length;
        document.getElementById('char-count').innerText = `${count} Active`;

        // Update editing character name
        const editingChar = appData.chars.find(c => c.id === editingCharId);
        if (editingChar) {
            const nameField = editingChar.sections.find(s => s.id === 'identity')?.fields.find(f => f.key === 'name');
            const charName = nameField?.value || editingChar.name || 'åç„¡ã—';
            document.getElementById('editing-char-name').innerText = `ç·¨é›†ä¸­: ${charName}`;
        }
    }

    function renderCharEditor() {
        const c = appData.chars.find(x => x.id === editingCharId);
        if (!c) return;

        const editor = document.getElementById('char-editor');
        editor.innerHTML = '';

        // Render each section
        c.sections.forEach((section, sectionIdx) => {
            const card = document.createElement('div');
            card.className = 'section-card';

            const header = document.createElement('div');
            header.className = 'section-header';

            const title = document.createElement('div');
            title.className = 'section-title';
            title.textContent = section.name;

            const actions = document.createElement('div');
            actions.className = 'section-actions';

            // Add Field button
            const addFieldBtn = document.createElement('button');
            addFieldBtn.className = 'btn btn-success';
            addFieldBtn.textContent = '+ ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰';
            addFieldBtn.onclick = () => addField(sectionIdx);
            actions.appendChild(addFieldBtn);

            // Delete Section button (only for non-fixed sections)
            if (!section.fixed) {
                const delSectionBtn = document.createElement('button');
                delSectionBtn.className = 'btn btn-danger';
                delSectionBtn.textContent = 'Ã— å‰Šé™¤';
                delSectionBtn.onclick = () => deleteSection(sectionIdx);
                actions.appendChild(delSectionBtn);
            }

            header.appendChild(title);
            header.appendChild(actions);
            card.appendChild(header);

            // Render fields in grid
            const grid = document.createElement('div');
            grid.className = 'fields-grid';

            section.fields.forEach((field, fieldIdx) => {
                const fieldContainer = document.createElement('div');
                fieldContainer.className = 'field-item-inline';

                const fieldItem = document.createElement('div');
                fieldItem.className = 'field-item';

                const label = document.createElement('label');
                label.textContent = field.label;
                fieldItem.appendChild(label);

                let input;
                if (field.type === 'textarea') {
                    input = document.createElement('textarea');
                    input.rows = 3;
                } else {
                    input = document.createElement('input');
                    input.type = 'text';
                }
                input.value = field.value || '';
                input.oninput = () => updateField(sectionIdx, fieldIdx, input.value);
                fieldItem.appendChild(input);

                fieldContainer.appendChild(fieldItem);

                // Delete field button (only for non-fixed fields)
                if (!field.fixed) {
                    const delBtn = document.createElement('button');
                    delBtn.className = 'btn btn-danger';
                    delBtn.textContent = 'Ã—';
                    delBtn.onclick = () => deleteField(sectionIdx, fieldIdx);
                    fieldContainer.appendChild(delBtn);
                }

                grid.appendChild(fieldContainer);
            });

            card.appendChild(grid);
            editor.appendChild(card);
        });

        // Add Section button
        const addSectionBtn = document.createElement('button');
        addSectionBtn.className = 'btn btn-primary btn-dashed';
        addSectionBtn.style.width = '100%';
        addSectionBtn.style.marginBottom = '20px';
        addSectionBtn.textContent = '+ æ–°è¦ã‚»ã‚¯ã‚·ãƒ§ãƒ³è¿½åŠ ';
        addSectionBtn.onclick = addSection;
        editor.appendChild(addSectionBtn);

        // Delete Character button
        const deleteCharBtn = document.createElement('button');
        deleteCharBtn.className = 'btn btn-danger';
        deleteCharBtn.style.width = '100%';
        deleteCharBtn.style.marginTop = '50px';
        deleteCharBtn.textContent = 'ã“ã®ã‚­ãƒ£ãƒ©ã‚’å‰Šé™¤';
        deleteCharBtn.onclick = deleteChar;
        editor.appendChild(deleteCharBtn);

        const spacer = document.createElement('div');
        spacer.style.height = '50px';
        editor.appendChild(spacer);
    }

    function updateField(sectionIdx, fieldIdx, value) {
        const c = appData.chars.find(x => x.id === editingCharId);
        c.sections[sectionIdx].fields[fieldIdx].value = value;

        // Update character name in real-time
        if (c.sections[sectionIdx].id === 'identity' &&
            c.sections[sectionIdx].fields[fieldIdx].key === 'name') {
            c.name = value;
            const activeItem = document.querySelector('.char-item.is-editing .char-name');
            if (activeItem) activeItem.innerText = value || 'åç„¡ã—';
        }

        saveDB();
    }

    function addSection() {
        const c = appData.chars.find(x => x.id === editingCharId);
        const sectionName = prompt('ã‚»ã‚¯ã‚·ãƒ§ãƒ³åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
        if (!sectionName) return;

        const newSection = {
            id: 'section_' + Date.now(),
            name: sectionName,
            fixed: false,
            fields: []
        };
        c.sections.push(newSection);
        saveDB();
        renderCharEditor();
    }

    function deleteSection(sectionIdx) {
        const c = appData.chars.find(x => x.id === editingCharId);
        if (c.sections[sectionIdx].fixed) {
            alert('å›ºå®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯å‰Šé™¤ã§ãã¾ã›ã‚“');
            return;
        }
        if (!confirm(`ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã€Œ${c.sections[sectionIdx].name}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
        c.sections.splice(sectionIdx, 1);
        saveDB();
        renderCharEditor();
    }

    function addField(sectionIdx) {
        const c = appData.chars.find(x => x.id === editingCharId);
        const fieldLabel = prompt('ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:');
        if (!fieldLabel) return;

        const fieldType = confirm('è¤‡æ•°è¡Œã®ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã«ã—ã¾ã™ã‹ï¼Ÿ\nï¼ˆOKã§ãƒ†ã‚­ã‚¹ãƒˆã‚¨ãƒªã‚¢ã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã§1è¡Œå…¥åŠ›ï¼‰') ? 'textarea' : 'text';

        const newField = {
            key: 'field_' + Date.now(),
            label: fieldLabel,
            value: '',
            type: fieldType,
            fixed: false
        };
        c.sections[sectionIdx].fields.push(newField);
        saveDB();
        renderCharEditor();
    }

    function deleteField(sectionIdx, fieldIdx) {
        const c = appData.chars.find(x => x.id === editingCharId);
        const field = c.sections[sectionIdx].fields[fieldIdx];
        if (field.fixed) {
            alert('å›ºå®šãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯å‰Šé™¤ã§ãã¾ã›ã‚“');
            return;
        }
        if (!confirm(`ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã€Œ${field.label}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;
        c.sections[sectionIdx].fields.splice(fieldIdx, 1);
        saveDB();
        renderCharEditor();
    }

    window.addNewChar = () => {
        const newChar = createDefaultCharacter();
        newChar.id = Date.now();
        newChar.name = "æ–°è¦ã‚­ãƒ£ãƒ©";
        newChar.active = false;
        appData.chars.push(newChar);
        editingCharId = newChar.id;
        saveDB();
        renderAll();
    }

    window.deleteChar = () => {
        if (appData.chars.length <= 1) {
            alert('æœ€å¾Œã®ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼ã¯å‰Šé™¤ã§ãã¾ã›ã‚“');
            return;
        }
        const c = appData.chars.find(x => x.id === editingCharId);
        const nameField = c.sections.find(s => s.id === 'identity')?.fields.find(f => f.key === 'name');
        const charName = nameField?.value || c.name || 'åç„¡ã—';
        if (!confirm(`ã€Œ${charName}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) return;

        appData.chars = appData.chars.filter(ch => ch.id !== editingCharId);
        editingCharId = appData.chars[0].id;
        saveDB();
        renderAll();
    }

    // --- Relationship Matrix ---
    function renderRelationshipMatrix() {
        const matrix = document.getElementById('relationship-matrix');
        const activeChars = appData.chars.filter(c => c.active);
        const mode = appData.generationMode;

        // Only show for multi or all mode with 2+ active characters
        if ((mode === 'multi' || mode === 'all') && activeChars.length >= 2) {
            matrix.style.display = 'block';
            matrix.innerHTML = '<div class="section-title">ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼é–“é–¢ä¿‚æ€§</div>';

            // Generate all pairs
            for (let i = 0; i < activeChars.length; i++) {
                for (let j = i + 1; j < activeChars.length; j++) {
                    const char1 = activeChars[i];
                    const char2 = activeChars[j];

                    const name1 = char1.sections.find(s => s.id === 'identity')?.fields.find(f => f.key === 'name')?.value || char1.name;
                    const name2 = char2.sections.find(s => s.id === 'identity')?.fields.find(f => f.key === 'name')?.value || char2.name;

                    const relKey = `${char1.id}_${char2.id}`;
                    if (!appData.relationships[relKey]) {
                        appData.relationships[relKey] = { from1to2: '', from2to1: '' };
                    }

                    const pairDiv = document.createElement('div');
                    pairDiv.className = 'relationship-pair';

                    pairDiv.innerHTML = `
                        <div class="relationship-pair-header">${name1} â‡„ ${name2}</div>
                        <label>${name1}ã‹ã‚‰è¦‹ãŸ${name2}</label>
                        <input type="text" value="${appData.relationships[relKey].from1to2 || ''}"
                               oninput="updateRelationship('${relKey}', 'from1to2', this.value)"
                               placeholder="ä¾‹ï¼šå¹¼é¦´æŸ“ã€ä¿¡é ¼ã§ãã‚‹ä»²é–“">
                        <label style="margin-top:10px;">${name2}ã‹ã‚‰è¦‹ãŸ${name1}</label>
                        <input type="text" value="${appData.relationships[relKey].from2to1 || ''}"
                               oninput="updateRelationship('${relKey}', 'from2to1', this.value)"
                               placeholder="ä¾‹ï¼šæ†§ã‚Œã®å…ˆè¼©ã€é ¼ã‚Œã‚‹ç›¸æ£’">
                    `;

                    matrix.appendChild(pairDiv);
                }
            }
        } else {
            matrix.style.display = 'none';
        }
    }

    window.updateRelationship = (relKey, direction, value) => {
        if (!appData.relationships[relKey]) {
            appData.relationships[relKey] = { from1to2: '', from2to1: '' };
        }
        appData.relationships[relKey][direction] = value;
        saveDB();
    }

    // --- World & Save ---
    function loadWorldForm() {
        document.getElementById('world-name').value = appData.world.name || '';
        document.getElementById('world-setting').value = appData.world.setting || '';
        document.getElementById('world-rules').value = appData.world.rules || '';
        document.getElementById('world-situation').value = appData.world.situation || '';
    }

    window.updateWorld = () => {
        appData.world = {
            name: document.getElementById('world-name').value,
            setting: document.getElementById('world-setting').value,
            rules: document.getElementById('world-rules').value,
            situation: document.getElementById('world-situation').value
        };
        saveDB();
    }

    window.createSavePoint = () => {
        const n = document.getElementById('save-name').value;
        if (!n) {
            alert('ä¿å­˜åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
            return;
        }
        appData.saves.unshift({
            name: n,
            time: new Date().toLocaleString(),
            data: JSON.parse(JSON.stringify({
                w: appData.world,
                c: appData.chars,
                r: appData.relationships
            }))
        });
        document.getElementById('save-name').value = '';
        saveDB();
        renderSaveList();
    }

    function renderSaveList() {
        const l = document.getElementById('save-list');
        l.innerHTML = '';
        appData.saves.forEach((s, i) => {
            const d = document.createElement('div');
            d.style.cssText = 'padding:15px; border-bottom:1px solid #333; display:flex; justify-content:space-between; align-items:center;';
            d.innerHTML = `
                <div>
                    <div style="font-weight:bold">${s.name}</div>
                    <div style="font-size:0.75rem; color:#888">${s.time}</div>
                </div>
                <div style="display:flex; gap:10px;">
                    <button class="btn btn-primary" onclick="loadSave(${i})">Load</button>
                    <button class="btn btn-danger" onclick="delSave(${i})">Del</button>
                </div>
            `;
            l.appendChild(d);
        });
    }

    window.loadSave = (i) => {
        if (!confirm('ç¾åœ¨ã®çŠ¶æ…‹ã‚’ç ´æ£„ã—ã¦ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã‹ï¼Ÿ')) return;
        const s = appData.saves[i];
        appData.world = s.data.w;
        appData.chars = s.data.c;
        appData.relationships = s.data.r || {};
        editingCharId = appData.chars[0]?.id || null;
        saveDB();
        renderAll();
    }

    window.delSave = (i) => {
        if (!confirm('ã“ã®ã‚»ãƒ¼ãƒ–ãƒã‚¤ãƒ³ãƒˆã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) return;
        appData.saves.splice(i, 1);
        saveDB();
        renderSaveList();
    }

    // --- Prompt Generation ---
    function generatePrompt() {
        const mode = appData.generationMode;
        const w = appData.world;
        let activeChars = appData.chars.filter(c => c.active);
        let p = '';

        // Mode: single - current editing character only
        if (mode === 'single') {
            const currentChar = appData.chars.find(c => c.id === editingCharId);
            if (currentChar) {
                activeChars = [currentChar];
                p = generateCharacterPrompt(activeChars, false);
            }
        }
        // Mode: multi - active characters only
        else if (mode === 'multi') {
            p = generateCharacterPrompt(activeChars, false);
        }
        // Mode: world - world only
        else if (mode === 'world') {
            p = generateWorldPrompt(w);
        }
        // Mode: all - world + active characters (default)
        else {
            p = generateWorldPrompt(w);
            if (activeChars.length > 0) {
                p += '\n\n' + generateCharacterPrompt(activeChars, true);
            }
        }

        document.getElementById('generated-prompt').value = p;
    }

    function generateWorldPrompt(w) {
        return `# World Context

## Setting
- Name: ${w.name || '(æœªè¨­å®š)'}
- Setting: ${w.setting || '(æœªè¨­å®š)'}
- Rules: ${w.rules || '(æœªè¨­å®š)'}
- Current Situation: ${w.situation || '(æœªè¨­å®š)'}`;
    }

    function generateCharacterPrompt(chars, includeHeader) {
        let p = includeHeader ? '# Characters\n\n' : '';

        chars.forEach((c, idx) => {
            const nameField = c.sections.find(s => s.id === 'identity')?.fields.find(f => f.key === 'name');
            const charName = nameField?.value || c.name || 'åç„¡ã—';

            p += `## ${idx + 1}. ${charName}\n\n`;

            // Output all sections and fields
            c.sections.forEach(section => {
                if (section.fields.length === 0) return;

                p += `### ${section.name}\n`;
                section.fields.forEach(field => {
                    if (field.value && field.value.trim()) {
                        p += `- ${field.label}: ${field.value.replace(/\n/g, ' ')}\n`;
                    }
                });
                p += '\n';
            });

            // Add relationships if in multi/all mode and relationships exist
            const mode = appData.generationMode;
            if ((mode === 'multi' || mode === 'all') && chars.length >= 2) {
                const relatedChars = chars.filter(other => other.id !== c.id);
                const relationships = [];

                relatedChars.forEach(other => {
                    const otherName = other.sections.find(s => s.id === 'identity')?.fields.find(f => f.key === 'name')?.value || other.name;

                    // Check both directions of relationship
                    const key1 = `${c.id}_${other.id}`;
                    const key2 = `${other.id}_${c.id}`;

                    if (appData.relationships[key1]?.from1to2) {
                        relationships.push(`  - ${otherName}: ${appData.relationships[key1].from1to2}`);
                    } else if (appData.relationships[key2]?.from2to1) {
                        relationships.push(`  - ${otherName}: ${appData.relationships[key2].from2to1}`);
                    }
                });

                if (relationships.length > 0) {
                    p += `### Relationships\n${relationships.join('\n')}\n\n`;
                }
            }
        });

        return p;
    }

    window.copyPrompt = () => {
        const textarea = document.getElementById('generated-prompt');
        textarea.select();
        document.execCommand('copy');

        // Modern API fallback
        if (navigator.clipboard) {
            navigator.clipboard.writeText(textarea.value);
        }

        alert('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ');
    }

    window.downloadPrompt = () => {
        const textarea = document.getElementById('generated-prompt');
        const format = document.querySelector('input[name="exportFormat"]:checked').value;
        const content = textarea.value;

        // Get character name for filename
        const editingChar = appData.chars.find(c => c.id === editingCharId);
        let filename = 'prompt';
        if (editingChar) {
            const nameField = editingChar.sections.find(s => s.id === 'identity')?.fields.find(f => f.key === 'name');
            const charName = nameField?.value || editingChar.name || 'prompt';
            filename = charName.replace(/[^a-zA-Z0-9_\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FFF]/g, '_');
        }

        // Create blob and download
        const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${filename}.${format}`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);

        alert(`ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ ${filename}.${format} ã¨ã—ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã—ãŸ`);
    }

    init();
</script>
</body>
</html>
